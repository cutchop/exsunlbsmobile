Ext.ns("exsun","Ext.ux");Ext.regModel("Device",{fields:[{name:"text",type:"string"},{name:"phone",type:"string"},{name:"count",type:"int"}]});var deviceStore=new Ext.data.TreeStore({model:"Device",root:{items:structure},proxy:{type:"ajax",reader:{type:"tree",root:"items"}}});var map=new Ext.Map({mapOptions:{center:new google.maps.LatLng(_centerlat,_centerlon),zoom:12}});var marker=new google.maps.Marker();var infowindow=new google.maps.InfoWindow();google.maps.event.addListener(marker,"mousedown",function(){infowindow.open(map.map,marker)});Ext.ux.UniversalUI=Ext.extend(Ext.Panel,{fullscreen:true,layout:"card",items:[map],backText:"返回",useTitleAsBackText:true,initComponent:function(){this.navigationButton=new Ext.Button({hidden:Ext.is.Phone||Ext.Viewport.orientation=="landscape",text:"车辆列表",handler:this.onNavButtonTap,scope:this});this.backButton=new Ext.Button({text:this.backText,ui:"back",handler:this.onUiBack,hidden:true,scope:this});var a=[this.navigationButton];if(Ext.is.Phone){a.unshift(this.backButton)}this.navigationBar=new Ext.Toolbar({ui:"dark",dock:"top",title:this.title,items:a.concat(this.buttons||[])});this.navigationPanel=new Ext.NestedList({store:deviceStore,useToolbar:Ext.is.Phone?false:true,updateTitleText:false,dock:"left",hidden:!Ext.is.Phone&&Ext.Viewport.orientation=="portrait",toolbar:Ext.is.Phone?this.navigationBar:null,listeners:{itemtap:this.onNavPanelItemTap,scope:this},getItemTextTpl:function(b){return'<tpl if="leaf"></tpl><tpl if="!leaf"><span>{text}</span><span style="font-size:.7em;color:#999;margin-left:5px;font-weight:bold;">({count})</span></tpl><tpl if="leaf"><span>{text}</span><span style="font-size:.7em;color:#999;margin-left:5px;">{phone}</span></tpl>'}});this.navigationPanel.on("back",this.onNavBack,this);if(!Ext.is.Phone){this.navigationPanel.setWidth(250)}this.dockedItems=this.dockedItems||[];this.dockedItems.unshift(this.navigationBar);if(!Ext.is.Phone&&Ext.Viewport.orientation=="landscape"){this.dockedItems.unshift(this.navigationPanel)}else{if(Ext.is.Phone){this.items=this.items||[];this.items.unshift(this.navigationPanel)}}this.addEvents("navigate");Ext.ux.UniversalUI.superclass.initComponent.call(this)},toggleUiBackButton:function(){var h=this.navigationPanel;if(Ext.is.Phone){if(this.getActiveItem()===h){var c=h.getActiveItem(),d=h.items.indexOf(c),b=c.recordNode,f=h.renderTitleText(b),a=b?b.parentNode:null,g=(a&&!a.isRoot)?h.renderTitleText(a):this.title||"",e;if(d<=0){this.navigationBar.setTitle(this.title||"");this.backButton.hide()}else{this.navigationBar.setTitle(f);if(this.useTitleAsBackText){this.backButton.setText(g)}this.backButton.show()}}else{e=h.getActiveItem();b=e.recordNode;g=(b&&!b.isRoot)?h.renderTitleText(b):this.title||"";if(this.useTitleAsBackText){this.backButton.setText(g)}this.backButton.show()}this.navigationBar.doLayout()}},onUiBack:function(){var a=this.navigationPanel;if(this.getActiveItem()===a){a.onBackTap()}else{this.setActiveItem(a,{type:"slide",reverse:true})}this.toggleUiBackButton();this.fireEvent("navigate",this,{})},onNavPanelItemTap:function(j,c,a,g){var i=j.getStore(),d=i.getAt(c),k=d.node,b=this.navigationPanel,h=b.renderTitleText(k),f;if(d){f=d.get("phone")}if(f){this.setActiveItem(map,"slide")}if(Ext.Viewport.orientation=="portrait"&&!Ext.is.Phone&&!k.childNodes.length){this.navigationPanel.hide()}if(h){this.navigationBar.setTitle(h)}this.toggleUiBackButton();this.fireEvent("navigate",this,d)},onNavButtonTap:function(){this.navigationPanel.showBy(this.navigationButton,"fade")},layoutOrientation:function(b,a,c){if(!Ext.is.Phone){if(b=="portrait"){this.navigationPanel.hide(false);this.removeDocked(this.navigationPanel,false);if(this.navigationPanel.rendered){this.navigationPanel.el.appendTo(document.body)}this.navigationPanel.setFloating(true);this.navigationPanel.setHeight(400);this.navigationButton.show(false)}else{this.navigationPanel.setFloating(false);this.navigationPanel.show(false);this.navigationButton.hide(false);this.insertDocked(0,this.navigationPanel)}this.navigationBar.doComponentLayout()}Ext.ux.UniversalUI.superclass.layoutOrientation.call(this,b,a,c)}});exsun.Main={init:function(){this.refreshButton=new Ext.Button({ui:"plain",iconCls:"refresh",iconMask:true,hidden:true,handler:this.onRefreshButtonTap,scope:this});this.ui=new Ext.ux.UniversalUI({title:_cname,useTitleAsBackText:false,buttons:[{xtype:"spacer"},this.refreshButton],listeners:{navigate:this.onNavigate,scope:this}})},onNavigate:function(b,a){if(a.data&&a.data.phone){if(a.data.phone=="logout"){window.location="login.aspx";return}marker.setMap(null);infowindow.close();Ext.Ajax.request({url:"handler/vehicles.aspx?p="+a.data.phone,success:function(d){var e=Ext.decode(d.responseText);if(e[0].lat!=0&&e[0].lon!=0){var g=new google.maps.LatLng(e[0].lat,e[0].lon);marker.id=a.data.phone;marker.setTitle(a.data.text);marker.setPosition(g);marker.setMap(map.map);var f='<div style="font-size:100%;">设备名称:'+a.data.text+"<br />设备号码:"+a.data.phone+"<br />详细位置:"+e[0].place+'</div><div style="color:#999;font-size:80%;text-align:right;">'+e[0].time+"</div>";infowindow.setContent(f);infowindow.open(map.map,marker);map.map.setCenter(g);if(this.refreshButton.hidden){this.refreshButton.show()}}else{this.refreshButton.hide();var c=new Ext.LoadMask(Ext.getBody(),{msg:"无法获取到该设备的位置"});c.show();setTimeout(function(){c.hide()},1500)}},failure:function(d){this.refreshButton.hide();var c=new Ext.LoadMask(Ext.getBody(),{msg:"暂时无法获取到该设备的位置"});c.show();setTimeout(function(){c.hide()},1500)},scope:this})}else{this.refreshButton.hide()}},onRefreshButtonTap:function(){Ext.Ajax.request({url:"handler/vehicles.aspx?p="+marker.id,success:function(b){var c=Ext.decode(b.responseText);if(c[0].lat!=0&&c[0].lon!=0){var e=new google.maps.LatLng(c[0].lat,c[0].lon);marker.setPosition(e);marker.setMap(map.map);var d='<div style="font-size:100%;">设备名称:'+marker.getTitle()+"<br />设备号码:"+marker.id+"<br />详细位置:"+c[0].place+'</div><div style="color:#999;font-size:80%;text-align:right;">'+c[0].time+"</div>";infowindow.setContent(d);infowindow.open(map.map,marker);map.map.setCenter(e)}else{var a=new Ext.LoadMask(Ext.getBody(),{msg:"无法获取到该设备的位置"});a.show();setTimeout(function(){a.hide()},1500)}},failure:function(b){var a=new Ext.LoadMask(Ext.getBody(),{msg:"暂时无法获取到该设备的位置"});a.show();setTimeout(function(){a.hide()},1500)},scope:this})}};Ext.setup({glossOnIcon:true,onReady:function(){exsun.Main.init()}});